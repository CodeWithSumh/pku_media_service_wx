# 使用官方 Node 18 slim 镜像
FROM node:18-slim

# 设置工作目录
WORKDIR /app

# -------------------------------
# 1. 复制 package.json 和 package-lock.json
#    只复制依赖文件，避免覆盖 node_modules
# -------------------------------
COPY package*.json ./

# -------------------------------
# 2. 安装生产依赖
# -------------------------------
RUN npm install --production

# -------------------------------
# 3. 复制源码文件（不包含 node_modules）
# -------------------------------
COPY . .

# -------------------------------
# 4. 检查关键依赖是否安装成功（可选）
# -------------------------------
RUN ls -la node_modules | grep http-errors || echo "http-errors not found!"

# -------------------------------
# 5. 暴露端口
# -------------------------------
EXPOSE 8080

# -------------------------------
# 6. 启动命令
# -------------------------------
CMD ["node", "public/app.js"]
