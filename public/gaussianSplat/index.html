<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>3D Gaussian Splat Demo</title>

  <script type="importmap">
    {
      "imports": {
        "three": "./lib/three.module.js",
        "@mkkellogg/gaussian-splats-3d": "./lib/gaussian-splats-3d.module.js"
      }
    }
  </script>

  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      overflow: hidden;
      background: #000;
    }
  </style>
</head>

<body>
  <script type="module">
    import * as GaussianSplats3D from '@mkkellogg/gaussian-splats-3d';

    console.log('[GaussianSplat] page loaded');

    /**
     * 接收外部 postMessage，决定加载哪个 splat
     */
    window.addEventListener('message', async (event) => {
      console.log('[GaussianSplat] message received:', event.data);

      const data = event.data;
      if (!data || !data.pageParams || !data.pageParams.id) {
        console.error('[GaussianSplat] invalid message data');
        return;
      }

      try {
        /**
         * 1. 读取配置（你原有逻辑，保留）
         *    modelsBase 一般是当前云托管服务域名
         */
        const configResp = await fetch('model-url.json');
        if (!configResp.ok) {
          throw new Error('failed to load model-url.json');
        }

        const config = await configResp.json();
        const modelsBase = config.modelsBase;

        /**
         * 2. 根据 id 选择 splat 文件
         */
        const id = Number(data.pageParams.id);

        const keyMap = {
          1: 'huabiao.splat',
          2: 'boyata.splat',
          3: 'lidazhao.splat'
        };

        const key = keyMap[id] || 'huabiao.splat';

        /**
         * 3. 最关键的一步：
         *    直接使用云托管代理接口作为模型 URL
         *    ⚠️ 不 fetch、不解析、不处理
         */
        const splatUrl = `${modelsBase}/api/splat?key=${encodeURIComponent(key)}`;

        console.log('[GaussianSplat] loading via proxy:', splatUrl);

        /**
         * 4. 初始化 Viewer
         */
        const viewer = new GaussianSplats3D.Viewer({
          cameraUp: [0, -1, 0],
          initialCameraPosition: [
            0.2545772143590187,
            -0.022421991409040026,
            -5.515991088728122
          ],
          initialCameraLookAt: [0, 0, 0],
          sphericalHarmonicsDegree: 2
        });

        /**
         * 5. 加载 splat（140MB，必须 progressiveLoad）
         */
        await viewer.addSplatScene(splatUrl, {
          progressiveLoad: true
        });

        viewer.start();
        console.log('[GaussianSplat] viewer started');

      } catch (err) {
        console.error('[GaussianSplat] load error:', err);
      }
    });
  </script>
</body>

</html>