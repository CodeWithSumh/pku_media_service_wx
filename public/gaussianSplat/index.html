<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>3D Gaussian Splat Demo - Garden</title>
  <script type="text/javascript" src="js/util.js"></script>
  <script type="importmap">
    {
        "imports": {
            "three": "./lib/three.module.js",
            "@mkkellogg/gaussian-splats-3d": "./lib/gaussian-splats-3d.module.js"
        }
    }
  </script>
  <style>
    body {
      background-color: #000000;
      height: 100vh;
      margin: 0px;
    }
  </style>

</head>

<body>
  <script type="module">
    import * as GaussianSplats3D from '@mkkellogg/gaussian-splats-3d';
    import * as THREE from 'three';

    console.log('3D Gaussian Splat page loaded');

    window.addEventListener("message", async (event) => {
      console.log('Received message event:', event);
      console.log('Message data:', event.data);
      console.log('pageParams:', event.data?.pageParams);

      const { data } = event;

      // 检查消息数据是否有效
      if (!data || !data.pageParams || !data.pageParams.id) {
        console.error('Invalid message data: missing pageParams.id');
        return;
      }

      try {
        console.log('Loading model-url.json...');
        const configResponse = await fetch('model-url.json');
        console.log('Config response status:', configResponse.status);

        if (!configResponse.ok) {
          throw new Error(`HTTP error! status: ${configResponse.status}`);
        }

        const urlData = await configResponse.json();
        console.log('URL data loaded:', urlData);

        console.log('Fetching splat URL from API...');

        const pathId = parseInt(data.pageParams.id);
        console.log('Path ID:', pathId);

        const keyMap = {
          1: 'huabiao.splat',
          2: 'boyata.splat',
          3: 'lidazhao.splat'
        };

        const key = keyMap[pathId] || 'huabiao.splat';
        const apiUrl = `${urlData}/api/getTempUrl?key=${key}`;

        console.log('Fetching URL for key:', key);
        const response = await fetch(apiUrl);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('API response:', result);

        const path = result.url || result.data?.url;
        if (!path) {
          throw new Error('No URL returned from API');
        }

        console.log('Full path to model:', path);

        console.log('Initializing viewer...');
        const viewer = new GaussianSplats3D.Viewer({
          'cameraUp': [0, -1, 0],
          'initialCameraPosition': [0.2545772143590187, -0.022421991409040026, -5.515991088728122],
          'initialCameraLookAt': [0, 0, 0],
          'sphericalHarmonicsDegree': 2,
        });

        console.log('Loading splat scene...');
        viewer.addSplatScene(path, {
          'progressiveLoad': true
        }).then(() => {
          console.log('Splat scene loaded, starting viewer...');
          viewer.start();
          console.log('Viewer started successfully');
        }).catch(error => {
          console.error('Error loading splat scene:', error);
        });

      } catch (e) {
        console.error('Error in message handler:', e);
        console.error('Error details:', e.message);
        console.error('Stack:', e.stack);
      }
    })

  </script>
</body>

</html>